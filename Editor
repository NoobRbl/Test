-- Rainy Lucky Block UI (single button + 3s loading progress + chat /luckyblockmode toggle)

local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local TextChatService = game:GetService("TextChatService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local Player = Players.LocalPlayer
local PlayerGui = Player:WaitForChild("PlayerGui")

-- Cleanup old
pcall(function()
	local old = PlayerGui:FindFirstChild("RainyLuckyBlockUI")
	if old then old:Destroy() end
end)

-- ===== Helpers =====
local function round(ui, r)
	local c = Instance.new("UICorner")
	c.CornerRadius = UDim.new(0, r)
	c.Parent = ui
	return c
end

local function sendChat(msg)
	-- Prefer new TextChatService
	local ok = pcall(function()
		if TextChatService and TextChatService.ChatVersion == Enum.ChatVersion.TextChatService then
			local channels = TextChatService:FindFirstChild("TextChannels")
			local ch = channels and (channels:FindFirstChild("RBXGeneral") or channels:FindFirstChildWhichIsA("TextChannel"))
			if ch then
				ch:SendAsync(msg)
				return
			end
		end
		error("fallback")
	end)
	if ok then return true end

	-- Fallback: Default chat system
	local ok2 = pcall(function()
		local ev = ReplicatedStorage:WaitForChild("DefaultChatSystemChatEvents"):WaitForChild("SayMessageRequest")
		ev:FireServer(msg, "All")
	end)
	if ok2 then return true end

	-- Last fallback
	local ok3 = pcall(function()
		Player:Chat(msg)
	end)
	return ok3
end

-- ===== UI =====
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "RainyLuckyBlockUI"
screenGui.ResetOnSpawn = false
screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
screenGui.Parent = PlayerGui

local container = Instance.new("Frame")
container.Size = UDim2.new(0, 340, 0, 170)
container.Position = UDim2.new(0.5, 0, 0.5, 0)
container.AnchorPoint = Vector2.new(0.5, 0.5)
container.BackgroundColor3 = Color3.fromRGB(14, 18, 24)
container.BackgroundTransparency = 0.06
container.BorderSizePixel = 0
container.Parent = screenGui
round(container, 16)

-- Subtle outline
local stroke = Instance.new("UIStroke")
stroke.Thickness = 1
stroke.Transparency = 0.45
stroke.Color = Color3.fromRGB(110, 140, 190)
stroke.Parent = container

-- Header (draggable)
local header = Instance.new("Frame")
header.Size = UDim2.new(1, 0, 0, 42)
header.BackgroundColor3 = Color3.fromRGB(20, 26, 36)
header.BorderSizePixel = 0
header.Parent = container
round(header, 16)

local headerGrad = Instance.new("UIGradient")
headerGrad.Rotation = 90
headerGrad.Color = ColorSequence.new({
	ColorSequenceKeypoint.new(0, Color3.fromRGB(70, 120, 210)),
	ColorSequenceKeypoint.new(1, Color3.fromRGB(20, 26, 36))
})
headerGrad.Parent = header

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, -18, 1, 0)
title.Position = UDim2.new(0, 12, 0, 0)
title.BackgroundTransparency = 1
title.Text = "RAINY LUCKY BLOCK"
title.TextColor3 = Color3.fromRGB(240, 246, 252)
title.Font = Enum.Font.GothamSemibold
title.TextSize = 16
title.TextXAlignment = Enum.TextXAlignment.Left
title.Parent = header

local subtitle = Instance.new("TextLabel")
subtitle.Size = UDim2.new(1, -18, 0, 16)
subtitle.Position = UDim2.new(0, 12, 0, 46)
subtitle.BackgroundTransparency = 1
subtitle.Text = "Toggle luckyblock mode with loading process"
subtitle.TextColor3 = Color3.fromRGB(160, 170, 185)
subtitle.Font = Enum.Font.Gotham
subtitle.TextSize = 12
subtitle.TextXAlignment = Enum.TextXAlignment.Left
subtitle.Parent = container

-- Button
local button = Instance.new("TextButton")
button.Size = UDim2.new(0.92, 0, 0, 46)
button.Position = UDim2.new(0.04, 0, 0, 78)
button.BackgroundColor3 = Color3.fromRGB(34, 92, 180)
button.BorderSizePixel = 0
button.AutoButtonColor = false
button.Text = "Rainy Lucky Blocküé≤"
button.TextColor3 = Color3.fromRGB(255, 255, 255)
button.Font = Enum.Font.GothamBold
button.TextSize = 15
button.Parent = container
round(button, 12)

local btnGrad = Instance.new("UIGradient")
btnGrad.Rotation = 90
btnGrad.Color = ColorSequence.new({
	ColorSequenceKeypoint.new(0, Color3.fromRGB(70, 150, 240)),
	ColorSequenceKeypoint.new(1, Color3.fromRGB(34, 92, 180))
})
btnGrad.Parent = button

-- Status line
local status = Instance.new("TextLabel")
status.Size = UDim2.new(0.92, 0, 0, 18)
status.Position = UDim2.new(0.04, 0, 1, -26)
status.BackgroundTransparency = 1
status.Text = "Rainy Lucky Blocküé≤: Disable"
status.TextColor3 = Color3.fromRGB(248, 81, 73)
status.Font = Enum.Font.GothamMedium
status.TextSize = 13
status.TextXAlignment = Enum.TextXAlignment.Left
status.Parent = container

-- ===== Loading Overlay =====
local overlay = Instance.new("Frame")
overlay.Size = UDim2.new(1, 0, 1, 0)
overlay.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
overlay.BackgroundTransparency = 1
overlay.Visible = false
overlay.ZIndex = 50
overlay.Parent = screenGui

local overlayPanel = Instance.new("Frame")
overlayPanel.Size = UDim2.new(0, 360, 0, 120)
overlayPanel.Position = UDim2.new(0.5, 0, 0.5, 0)
overlayPanel.AnchorPoint = Vector2.new(0.5, 0.5)
overlayPanel.BackgroundColor3 = Color3.fromRGB(16, 20, 28)
overlayPanel.BorderSizePixel = 0
overlayPanel.ZIndex = 51
overlayPanel.Parent = overlay
round(overlayPanel, 16)

local overlayStroke = Instance.new("UIStroke")
overlayStroke.Thickness = 1
overlayStroke.Transparency = 0.55
overlayStroke.Color = Color3.fromRGB(95, 130, 190)
overlayStroke.Parent = overlayPanel

local loadingText = Instance.new("TextLabel")
loadingText.Size = UDim2.new(1, -20, 0, 24)
loadingText.Position = UDim2.new(0, 10, 0, 18)
loadingText.BackgroundTransparency = 1
loadingText.Text = "Loading..."
loadingText.TextColor3 = Color3.fromRGB(240, 246, 252)
loadingText.Font = Enum.Font.GothamSemibold
loadingText.TextSize = 16
loadingText.ZIndex = 52
loadingText.Parent = overlayPanel

local barOuter = Instance.new("Frame")
barOuter.Size = UDim2.new(0.92, 0, 0, 7) -- d√†i + m·ªèng
barOuter.Position = UDim2.new(0.04, 0, 0, 70)
barOuter.BackgroundColor3 = Color3.fromRGB(28, 34, 46)
barOuter.BorderSizePixel = 0
barOuter.ZIndex = 52
barOuter.Parent = overlayPanel
round(barOuter, 999)

local barFill = Instance.new("Frame")
barFill.Size = UDim2.new(0, 0, 1, 0)
barFill.Position = UDim2.new(0, 0, 0, 0)
barFill.BackgroundColor3 = Color3.fromRGB(90, 170, 255)
barFill.BorderSizePixel = 0
barFill.ZIndex = 53
barFill.Parent = barOuter
round(barFill, 999)

local fillGrad = Instance.new("UIGradient")
fillGrad.Rotation = 90
fillGrad.Color = ColorSequence.new({
	ColorSequenceKeypoint.new(0, Color3.fromRGB(140, 210, 255)),
	ColorSequenceKeypoint.new(1, Color3.fromRGB(60, 130, 255))
})
fillGrad.Parent = barFill

-- ===== Drag (header only) =====
local dragging = false
local dragStart, startPos, activeInput

local function updateDrag(input)
	local delta = input.Position - dragStart
	container.Position = UDim2.new(
		startPos.X.Scale, startPos.X.Offset + delta.X,
		startPos.Y.Scale, startPos.Y.Offset + delta.Y
	)
end

header.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
		dragging = true
		activeInput = input
		dragStart = input.Position
		startPos = container.Position
		input.Changed:Connect(function()
			if input.UserInputState == Enum.UserInputState.End then
				dragging = false
				activeInput = nil
			end
		end)
	end
end)

UserInputService.InputChanged:Connect(function(input)
	if dragging and input == activeInput then
		updateDrag(input)
	end
end)

-- ===== Button hover (soft) =====
local function tweenBtn(toColor0, toColor1)
	TweenService:Create(btnGrad, TweenInfo.new(0.18, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
		Color = ColorSequence.new({
			ColorSequenceKeypoint.new(0, toColor0),
			ColorSequenceKeypoint.new(1, toColor1)
		})
	}):Play()
end

button.MouseEnter:Connect(function()
	tweenBtn(Color3.fromRGB(160, 225, 255), Color3.fromRGB(70, 150, 240))
end)

button.MouseLeave:Connect(function()
	tweenBtn(Color3.fromRGB(70, 150, 240), Color3.fromRGB(34, 92, 180))
end)

-- ===== Logic =====
local enabled = false
local busy = false

local function setStatus(isEnabled)
	if isEnabled then
		status.Text = "Rainy Lucky Blocküé≤: Enable"
		status.TextColor3 = Color3.fromRGB(63, 185, 120)
	else
		status.Text = "Rainy Lucky Blocküé≤: Disable"
		status.TextColor3 = Color3.fromRGB(248, 81, 73)
	end
end

local function runLoading3s()
	overlay.Visible = true
	overlay.BackgroundTransparency = 1
	barFill.Size = UDim2.new(0, 0, 1, 0)

	-- Fade in overlay background a bit
	TweenService:Create(overlay, TweenInfo.new(0.18, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
		BackgroundTransparency = 0.45
	}):Play()

	-- Fill bar in exactly 3s
	local tw = TweenService:Create(barFill, TweenInfo.new(3, Enum.EasingStyle.Linear, Enum.EasingDirection.Out), {
		Size = UDim2.new(1, 0, 1, 0)
	})
	tw:Play()
	tw.Completed:Wait()

	-- Fade out overlay
	TweenService:Create(overlay, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
		BackgroundTransparency = 1
	}):Play()
	task.wait(0.2)
	overlay.Visible = false
end

button.Activated:Connect(function()
	if busy then return end
	busy = true
	button.Active = false

	-- click feedback (tiny)
	TweenService:Create(button, TweenInfo.new(0.08, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
		Size = UDim2.new(0.92, 0, 0, 44)
	}):Play()
	task.wait(0.08)
	TweenService:Create(button, TweenInfo.new(0.12, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
		Size = UDim2.new(0.92, 0, 0, 46)
	}):Play()

	-- Loading + action
	runLoading3s()
	sendChat("/luckyblockmode") -- toggle on/off
	enabled = not enabled
	setStatus(enabled)

	button.Active = true
	busy = false
end)

-- init
setStatus(false)
