local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")

local Player = Players.LocalPlayer
local PlayerGui = Player:WaitForChild("PlayerGui")

-- =========================
-- THEME (SÁNG + BG MỜ + Ô NỔI)
-- =========================
local ACCENT      = Color3.fromRGB(80, 180, 255)
local BG_MAIN     = Color3.fromRGB(245, 248, 255)
local BG_CARD     = Color3.fromRGB(235, 241, 252)
local TXT_MAIN    = Color3.fromRGB(25, 35, 55)
local TXT_SUB     = Color3.fromRGB(95, 110, 140)
local DROP_BG     = Color3.fromRGB(235, 241, 252)
local CLOSE_BG    = Color3.fromRGB(255, 120, 120)

-- Stroke (làm ô nổi hơn)
local STROKE_COL  = Color3.fromRGB(200, 220, 255)
local STROKE_TROW = 0.55   -- row stroke transparency
local STROKE_TBTN = 0.50   -- button stroke transparency
local STROKE_TDRP = 0.35   -- dropdown stroke transparency

-- =========================
-- CONFIG
-- =========================
local TARGET_W, TARGET_H = 320, 330
local DESIRED_DROP_H = 200

local traitOptions = {
	"All", "RIP Gravestone", "Sombrero", "Skeleton", "Meowl", "Zombie", "Taco", "Cometstruck",
	"Disco", "Witch Hat", "Fire", "Fireworks", "Snowy", "10B", "Claws", "Sleepy", "Lightning",
	"Tie", "Indonesia", "Nyan", "Santa Hat", "Matteo Hat", "Bubblegum", "Strawberry", "Shark Fin",
	"Brazil", "Explosive", "Wet", "Glitched", "Spider", "UFO", "Paint", "Galactic", "Jackolantern Pet"
}

-- =========================
-- GUI
-- =========================
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "BrainrotAdderGui"
screenGui.ResetOnSpawn = false
screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
screenGui.Parent = PlayerGui

-- Overlay click ngoài dropdown => đóng
local overlay = Instance.new("TextButton")
overlay.Name = "DropdownOverlay"
overlay.Size = UDim2.new(1, 0, 1, 0)
overlay.Position = UDim2.new(0, 0, 0, 0)
overlay.BackgroundTransparency = 1
overlay.Text = ""
overlay.AutoButtonColor = false
overlay.Visible = false
overlay.ZIndex = 90
overlay.Parent = screenGui

local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, TARGET_W, 0, TARGET_H)
mainFrame.Position = UDim2.new(0.5, 0, 0.5, 0)
mainFrame.AnchorPoint = Vector2.new(0.5, 0.5)
mainFrame.BackgroundColor3 = BG_MAIN
mainFrame.BackgroundTransparency = 0.18 -- ✅ background mờ hơn
mainFrame.BorderSizePixel = 0
mainFrame.ZIndex = 91
mainFrame.Parent = screenGui

local corner = Instance.new("UICorner")
corner.CornerRadius = UDim.new(0, 15)
corner.Parent = mainFrame

local header = Instance.new("Frame")
header.Size = UDim2.new(1, 0, 0, 50)
header.BackgroundColor3 = ACCENT
header.BackgroundTransparency = 0.08 -- ✅ header mờ nhẹ
header.BorderSizePixel = 0
header.ZIndex = 92
header.Parent = mainFrame

local headerCorner = Instance.new("UICorner")
headerCorner.CornerRadius = UDim.new(0, 15)
headerCorner.Parent = header

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, -60, 1, 0)
title.Position = UDim2.new(0, 15, 0, 0)
title.BackgroundTransparency = 1
title.Text = "BRAINROT SPAWNER"
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.Font = Enum.Font.GothamBold
title.TextSize = 18
title.TextXAlignment = Enum.TextXAlignment.Left
title.TextYAlignment = Enum.TextYAlignment.Center
title.ZIndex = 93
title.Parent = header

local closeButton = Instance.new("TextButton")
closeButton.Size = UDim2.new(0, 32, 0, 32)
closeButton.Position = UDim2.new(1, -37, 0.5, 0)
closeButton.AnchorPoint = Vector2.new(0, 0.5)
closeButton.BackgroundColor3 = CLOSE_BG
closeButton.BackgroundTransparency = 0.05
closeButton.Text = "X"
closeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
closeButton.Font = Enum.Font.GothamBold
closeButton.TextSize = 16
closeButton.AutoButtonColor = false
closeButton.ZIndex = 93
closeButton.Parent = header

local closeButtonCorner = Instance.new("UICorner")
closeButtonCorner.CornerRadius = UDim.new(0, 8)
closeButtonCorner.Parent = closeButton

-- =========================
-- CONTENT
-- =========================
local content = Instance.new("Frame")
content.Size = UDim2.new(1, 0, 1, -60)
content.Position = UDim2.new(0, 0, 0, 60)
content.BackgroundTransparency = 1
content.ZIndex = 92
content.Parent = mainFrame

local container = Instance.new("Frame")
container.Size = UDim2.new(1, -30, 1, -20)
container.Position = UDim2.new(0, 15, 0, 15)
container.BackgroundTransparency = 1
container.ZIndex = 92
container.Parent = content

local layout = Instance.new("UIListLayout")
layout.Padding = UDim.new(0, 8)
layout.SortOrder = Enum.SortOrder.LayoutOrder
layout.Parent = container

local function makeRow(height)
	local row = Instance.new("Frame")
	row.Size = UDim2.new(1, 0, 0, height or 46)
	row.BackgroundColor3 = BG_CARD
	row.BackgroundTransparency = 0.02 -- ✅ ô nổi hơn
	row.BorderSizePixel = 0
	row.ZIndex = 92
	row.Parent = container

	local c = Instance.new("UICorner")
	c.CornerRadius = UDim.new(0, 10)
	c.Parent = row

	-- ✅ stroke nhẹ để nổi
	local stroke = Instance.new("UIStroke")
	stroke.Color = STROKE_COL
	stroke.Thickness = 1
	stroke.Transparency = STROKE_TROW
	stroke.Parent = row

	return row
end

local function makeLabeledTextBox(row, labelText, placeholderText)
	local pl = Instance.new("TextLabel")
	pl.Text = labelText
	pl.TextColor3 = TXT_SUB
	pl.BackgroundTransparency = 1
	pl.Font = Enum.Font.GothamSemibold
	pl.TextSize = 11
	pl.Position = UDim2.new(0, 12, 0, -16)
	pl.Size = UDim2.new(0.9, 0, 0, 16)
	pl.TextXAlignment = Enum.TextXAlignment.Left
	pl.ZIndex = 93
	pl.Parent = row

	local tb = Instance.new("TextBox")
	tb.Size = UDim2.new(1, -20, 1, 0)
	tb.Position = UDim2.new(0, 10, 0, 0)
	tb.PlaceholderText = placeholderText or ""
	tb.PlaceholderColor3 = TXT_SUB
	tb.BackgroundTransparency = 1
	tb.TextColor3 = TXT_MAIN
	tb.ClearTextOnFocus = false
	tb.Font = Enum.Font.Gotham
	tb.TextSize = 15
	tb.TextXAlignment = Enum.TextXAlignment.Left
	tb.TextYAlignment = Enum.TextYAlignment.Center
	tb.Text = "" -- ✅ không còn chữ "TextBox"
	tb.ZIndex = 93
	tb.Parent = row

	return tb
end

-- Row: Brainrot name
local rowName = makeRow(46)
local brainrotBox = makeLabeledTextBox(rowName, "BRAINROT NAME", "Enter brainrot name here")

-- Row: Mutations
local rowMut = makeRow(46)
local mutationBox = makeLabeledTextBox(rowMut, "Mutations", "Enter mutations here")

-- Row: Traits selector
local rowTraits = makeRow(46)

local traitsLabel = Instance.new("TextLabel")
traitsLabel.Text = "TRAITS"
traitsLabel.TextColor3 = TXT_SUB
traitsLabel.BackgroundTransparency = 1
traitsLabel.Font = Enum.Font.GothamSemibold
traitsLabel.TextSize = 11
traitsLabel.Position = UDim2.new(0, 12, 0, -16)
traitsLabel.Size = UDim2.new(0.9, 0, 0, 16)
traitsLabel.TextXAlignment = Enum.TextXAlignment.Left
traitsLabel.ZIndex = 93
traitsLabel.Parent = rowTraits

local traitsValue = Instance.new("TextLabel")
traitsValue.Size = UDim2.new(1, -70, 1, 0)
traitsValue.Position = UDim2.new(0, 12, 0, 0)
traitsValue.BackgroundTransparency = 1
traitsValue.TextColor3 = TXT_MAIN
traitsValue.Font = Enum.Font.Gotham
traitsValue.TextSize = 14
traitsValue.TextXAlignment = Enum.TextXAlignment.Left
traitsValue.Text = "Select traits..."
traitsValue.ZIndex = 93
traitsValue.Parent = rowTraits

local caret = Instance.new("TextLabel")
caret.Size = UDim2.new(0, 24, 0, 24)
caret.Position = UDim2.new(1, -30, 0.5, 0)
caret.AnchorPoint = Vector2.new(0, 0.5)
caret.BackgroundTransparency = 1
caret.Text = "▾"
caret.TextColor3 = TXT_MAIN
caret.Font = Enum.Font.GothamBold
caret.TextSize = 18
caret.ZIndex = 93
caret.Parent = rowTraits

local traitsButton = Instance.new("TextButton")
traitsButton.Size = UDim2.new(1, 0, 1, 0)
traitsButton.BackgroundTransparency = 1
traitsButton.Text = ""
traitsButton.AutoButtonColor = false
traitsButton.ZIndex = 94
traitsButton.Parent = rowTraits

-- Row: Spawn (UI only)
local spawnRow = makeRow(50)
spawnRow.BackgroundTransparency = 1

local spawnButton = Instance.new("TextButton")
spawnButton.Size = UDim2.new(1, 0, 0, 50)
spawnButton.Text = "SPAWN"
spawnButton.BackgroundColor3 = ACCENT
spawnButton.BackgroundTransparency = 0 -- ✅ nút nổi rõ
spawnButton.TextColor3 = Color3.fromRGB(255, 255, 255)
spawnButton.Font = Enum.Font.GothamBold
spawnButton.TextSize = 16
spawnButton.AutoButtonColor = false
spawnButton.ZIndex = 92
spawnButton.Parent = spawnRow

local spawnCorner = Instance.new("UICorner")
spawnCorner.CornerRadius = UDim.new(0, 10)
spawnCorner.Parent = spawnButton

-- ✅ stroke nút
local spawnStroke = Instance.new("UIStroke")
spawnStroke.Color = Color3.fromRGB(255, 255, 255)
spawnStroke.Thickness = 1
spawnStroke.Transparency = STROKE_TBTN
spawnStroke.Parent = spawnButton

-- =========================
-- Dropdown OVERLAY (đè lên SPAWN) + Multi-select + All
-- =========================
local selected = {}
local optionUI = {}

local dropdown = Instance.new("Frame")
dropdown.BackgroundColor3 = DROP_BG
dropdown.BackgroundTransparency = 0 -- ✅ dropdown rõ hơn
dropdown.BorderSizePixel = 0
dropdown.ClipsDescendants = true
dropdown.Visible = false
dropdown.ZIndex = 110
dropdown.Parent = mainFrame

local dropCorner = Instance.new("UICorner")
dropCorner.CornerRadius = UDim.new(0, 10)
dropCorner.Parent = dropdown

-- ✅ stroke dropdown
local dropStroke = Instance.new("UIStroke")
dropStroke.Color = STROKE_COL
dropStroke.Thickness = 1
dropStroke.Transparency = STROKE_TDRP
dropStroke.Parent = dropdown

local list = Instance.new("ScrollingFrame")
list.Size = UDim2.new(1, -10, 1, -10)
list.Position = UDim2.new(0, 5, 0, 5)
list.BackgroundTransparency = 1
list.BorderSizePixel = 0
list.ScrollBarThickness = 4
list.CanvasSize = UDim2.new(0, 0, 0, 0)
list.ZIndex = 111
list.Parent = dropdown

local optLayout = Instance.new("UIListLayout")
optLayout.Padding = UDim.new(0, 6)
optLayout.SortOrder = Enum.SortOrder.LayoutOrder
optLayout.Parent = list

local function recomputeCanvas()
	task.wait()
	list.CanvasSize = UDim2.new(0, 0, 0, optLayout.AbsoluteContentSize.Y + 6)
end
optLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(recomputeCanvas)

local function anySelected()
	for _, opt in ipairs(traitOptions) do
		if selected[opt] then return true end
	end
	return false
end

local function countSelected()
	local n = 0
	for _, opt in ipairs(traitOptions) do
		if selected[opt] then n += 1 end
	end
	return n
end

local function allOthersOn()
	for _, opt in ipairs(traitOptions) do
		if opt ~= "All" and not selected[opt] then
			return false
		end
	end
	return true
end

local function refreshTraitsText()
	if not anySelected() then
		traitsValue.Text = "Select traits..."
		return
	end
	if selected["All"] then
		traitsValue.Text = "All (" .. tostring(#traitOptions) .. ")"
	else
		traitsValue.Text = tostring(countSelected()) .. " selected"
	end
end

local function setOptionVisual(opt)
	local ui = optionUI[opt]
	if not ui then return end
	if selected[opt] then
		ui.box.BackgroundColor3 = ACCENT
		ui.tick.TextTransparency = 0
	else
		ui.box.BackgroundColor3 = Color3.fromRGB(210, 220, 240)
		ui.tick.TextTransparency = 1
	end
end

local function setAll(on)
	for _, opt in ipairs(traitOptions) do
		selected[opt] = on
	end
	for _, opt in ipairs(traitOptions) do
		setOptionVisual(opt)
	end
	refreshTraitsText()
end

local function toggleOption(opt)
	if opt == "All" then
		setAll(not selected["All"])
		return
	end

	selected[opt] = not selected[opt]
	setOptionVisual(opt)

	if selected["All"] and not selected[opt] then
		selected["All"] = false
		setOptionVisual("All")
	end

	if allOthersOn() then
		selected["All"] = true
		setOptionVisual("All")
	end

	refreshTraitsText()
end

for i, opt in ipairs(traitOptions) do
	local row = Instance.new("TextButton")
	row.Size = UDim2.new(1, 0, 0, 30)
	row.BackgroundTransparency = 1
	row.Text = ""
	row.AutoButtonColor = false
	row.LayoutOrder = i
	row.ZIndex = 112
	row.Parent = list

	local txt = Instance.new("TextLabel")
	txt.Size = UDim2.new(1, -60, 1, 0)
	txt.Position = UDim2.new(0, 10, 0, 0)
	txt.BackgroundTransparency = 1
	txt.TextColor3 = TXT_MAIN
	txt.Font = Enum.Font.Gotham
	txt.TextSize = 14
	txt.TextXAlignment = Enum.TextXAlignment.Left
	txt.Text = opt
	txt.ZIndex = 113
	txt.Parent = row

	local box = Instance.new("Frame")
	box.Size = UDim2.new(0, 16, 0, 16)
	box.Position = UDim2.new(1, -26, 0.5, 0)
	box.AnchorPoint = Vector2.new(0, 0.5)
	box.BackgroundColor3 = Color3.fromRGB(210, 220, 240)
	box.BorderSizePixel = 0
	box.ZIndex = 113
	box.Parent = row

	local bc = Instance.new("UICorner")
	bc.CornerRadius = UDim.new(0, 3)
	bc.Parent = box

	local tick = Instance.new("TextLabel")
	tick.Size = UDim2.new(1, 0, 1, 0)
	tick.BackgroundTransparency = 1
	tick.Text = "✓"
	tick.TextColor3 = Color3.fromRGB(255, 255, 255)
	tick.Font = Enum.Font.GothamBold
	tick.TextSize = 14
	tick.TextTransparency = 1
	tick.ZIndex = 114
	tick.Parent = box

	optionUI[opt] = {box = box, tick = tick}

	row.Activated:Connect(function()
		toggleOption(opt)
	end)
end

task.defer(function()
	recomputeCanvas()
	refreshTraitsText()
end)

local function placeDropdown(h)
	local x = 0
	local w = mainFrame.AbsoluteSize.X
	local traitsBottomY = (rowTraits.AbsolutePosition.Y - mainFrame.AbsolutePosition.Y) + rowTraits.AbsoluteSize.Y
	local topY = traitsBottomY + 8

	local maxH = math.max(0, (mainFrame.AbsoluteSize.Y - 12) - topY)
	local finalH = math.min(h, maxH)

	dropdown.Position = UDim2.new(0, x, 0, topY)
	dropdown.Size = UDim2.new(0, w, 0, finalH)
end

local dropOpen = false
local dropTween

local function setDropdown(open)
	dropOpen = open
	caret.Text = open and "▴" or "▾"

	if dropTween then
		dropTween:Cancel()
		dropTween = nil
	end

	if open then
		overlay.Visible = true
		dropdown.Visible = true
		placeDropdown(DESIRED_DROP_H)
		local targetH = dropdown.AbsoluteSize.Y

		dropdown.Size = UDim2.new(dropdown.Size.X.Scale, dropdown.Size.X.Offset, 0, 0)
		dropTween = TweenService:Create(dropdown, TweenInfo.new(0.18, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
			Size = UDim2.new(dropdown.Size.X.Scale, dropdown.Size.X.Offset, 0, targetH)
		})
		dropTween:Play()
	else
		overlay.Visible = false
		if not dropdown.Visible then return end
		dropTween = TweenService:Create(dropdown, TweenInfo.new(0.14, Enum.EasingStyle.Quad, Enum.EasingDirection.In), {
			Size = UDim2.new(dropdown.Size.X.Scale, dropdown.Size.X.Offset, 0, 0)
		})
		dropTween:Play()
		dropTween.Completed:Connect(function()
			if not dropOpen then dropdown.Visible = false end
		end)
	end
end

traitsButton.Activated:Connect(function()
	setDropdown(not dropOpen)
end)

overlay.Activated:Connect(function()
	if dropOpen then setDropdown(false) end
end)

-- =========================
-- Draggable header (GIỮ LẠI)
-- =========================
local dragging = false
local dragStart
local startPos

local function updateDrag(input)
	local delta = input.Position - dragStart
	mainFrame.Position = UDim2.new(
		startPos.X.Scale,
		startPos.X.Offset + delta.X,
		startPos.Y.Scale,
		startPos.Y.Offset + delta.Y
	)
	if dropOpen and dropdown.Visible then
		placeDropdown(dropdown.AbsoluteSize.Y)
	end
end

header.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
		dragging = true
		dragStart = input.Position
		startPos = mainFrame.Position

		local connection
		connection = input.Changed:Connect(function()
			if input.UserInputState == Enum.UserInputState.End then
				dragging = false
				if connection then connection:Disconnect() end
			end
		end)
	end
end)

UserInputService.InputChanged:Connect(function(input)
	if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
		updateDrag(input)
	end
end)

closeButton.Activated:Connect(function()
	screenGui:Destroy()
end)

-- =========================
-- SPAWN FUNCTIONALITY
-- =========================
local function buildTraitsString()
	if selected["All"] then
		return "All"
	else
		local list = {}
		for _, opt in ipairs(traitOptions) do
			if opt ~= "All" and selected[opt] then
				table.insert(list, opt)
			end
		end
		if #list == 0 then
			return ""
		else
			return table.concat(list, ", ")
		end
	end
end

local function spawnBrainrot()
	-- Đóng dropdown nếu đang mở
	if dropOpen then
		setDropdown(false)
	end

	-- Lấy dữ liệu từ các input
	local brainrotName = brainrotBox.Text
	local mutations = mutationBox.Text
	local traits = buildTraitsString()

	-- Kiểm tra tên brainrot (bắt buộc)
	if brainrotName == "" then
		brainrotBox.PlaceholderText = "Please enter brainrot name!"
		brainrotBox.PlaceholderColor3 = Color3.fromRGB(255, 100, 100)
		return
	end

	-- Chuẩn bị args để gửi đến server
	local args = {
		[1] = brainrotName,
		[2] = mutations,
		[3] = traits
	}

	-- Gọi remote function để spawn brainrot
	local success, errorMessage = pcall(function()
		game:GetService("ReplicatedStorage").Packages.Net:FindFirstChild("RF/AdminService/SpawnBrainrot"):InvokeServer(unpack(args))
	end)

	if not success then
		warn("Failed to spawn brainrot:", errorMessage)
		-- Có thể thêm thông báo lỗi cho người dùng ở đây
	end
end

-- Thêm hiệu ứng nhấn nút
spawnButton.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
		spawnButton.BackgroundTransparency = 0.3
	end
end)

spawnButton.InputEnded:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
		spawnButton.BackgroundTransparency = 0
	end
end)

-- Kết nối sự kiện spawn
spawnButton.Activated:Connect(spawnBrainrot)

-- Đặt lại placeholder màu khi người dùng bắt đầu nhập
brainrotBox.Focused:Connect(function()
	brainrotBox.PlaceholderText = "Enter brainrot name here"
	brainrotBox.PlaceholderColor3 = TXT_SUB
end)
