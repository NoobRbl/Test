-- Rainy Lucky Block UI
-- - Loading FULL mÃ n hÃ¬nh ná»n Ä‘en + process fill 3s + title "Waiting to turn on the lucky block rain"
-- - Button: Loading 3s -> chat /luckyblockmode -> toggle Enable/Disable -> áº¨N UI panel
-- - Mini ðŸŽ² button (gÃ³c pháº£i dÆ°á»›i): má»Ÿ láº¡i UI panel
-- - âŒ: náº¿u Ä‘ang Enable thÃ¬ chat /luckyblockmode Ä‘á»ƒ táº¯t, rá»“i Destroy GUI

local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local TextChatService = game:GetService("TextChatService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local Player = Players.LocalPlayer
local PlayerGui = Player:WaitForChild("PlayerGui")

pcall(function()
	local old = PlayerGui:FindFirstChild("RainyLuckyBlockUI")
	if old then old:Destroy() end
end)

-- ===== Helpers =====
local function round(ui, r)
	local c = Instance.new("UICorner")
	c.CornerRadius = UDim.new(0, r)
	c.Parent = ui
	return c
end

local function sendChat(msg)
	local ok = pcall(function()
		if TextChatService and TextChatService.ChatVersion == Enum.ChatVersion.TextChatService then
			local channels = TextChatService:FindFirstChild("TextChannels")
			local ch = channels and (channels:FindFirstChild("RBXGeneral") or channels:FindFirstChildWhichIsA("TextChannel"))
			if ch then
				ch:SendAsync(msg)
				return
			end
		end
		error("fallback")
	end)
	if ok then return true end

	local ok2 = pcall(function()
		local ev = ReplicatedStorage:WaitForChild("DefaultChatSystemChatEvents"):WaitForChild("SayMessageRequest")
		ev:FireServer(msg, "All")
	end)
	if ok2 then return true end

	local ok3 = pcall(function()
		Player:Chat(msg)
	end)
	return ok3
end

local function setAllTransparency(root, t)
	for _, d in ipairs(root:GetDescendants()) do
		if d:IsA("Frame") then
			d.BackgroundTransparency = t
		elseif d:IsA("TextLabel") or d:IsA("TextButton") then
			d.BackgroundTransparency = t
			if d:IsA("TextLabel") then
				d.TextTransparency = t
			else
				d.TextTransparency = t
			end
		elseif d:IsA("UIStroke") then
			d.Transparency = math.clamp(t + 0.25, 0, 1)
		end
	end
	root.BackgroundTransparency = t
end

-- ===== UI Base =====
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "RainyLuckyBlockUI"
screenGui.ResetOnSpawn = false
screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
screenGui.Parent = PlayerGui

-- Main panel
local container = Instance.new("Frame")
container.Size = UDim2.new(0, 340, 0, 160)
container.Position = UDim2.new(0.5, 0, 0.5, 0)
container.AnchorPoint = Vector2.new(0.5, 0.5)
container.BackgroundColor3 = Color3.fromRGB(14, 18, 24)
container.BackgroundTransparency = 0.06
container.BorderSizePixel = 0
container.Parent = screenGui
round(container, 16)

local stroke = Instance.new("UIStroke")
stroke.Thickness = 1
stroke.Transparency = 0.45
stroke.Color = Color3.fromRGB(110, 140, 190)
stroke.Parent = container

local header = Instance.new("Frame")
header.Size = UDim2.new(1, 0, 0, 42)
header.BackgroundColor3 = Color3.fromRGB(20, 26, 36)
header.BorderSizePixel = 0
header.Parent = container
round(header, 16)

local headerGrad = Instance.new("UIGradient")
headerGrad.Rotation = 90
headerGrad.Color = ColorSequence.new({
	ColorSequenceKeypoint.new(0, Color3.fromRGB(70, 120, 210)),
	ColorSequenceKeypoint.new(1, Color3.fromRGB(20, 26, 36))
})
headerGrad.Parent = header

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, -60, 1, 0)
title.Position = UDim2.new(0, 12, 0, 0)
title.BackgroundTransparency = 1
title.Text = "RAINY LUCKY BLOCK"
title.TextColor3 = Color3.fromRGB(240, 246, 252)
title.Font = Enum.Font.GothamSemibold
title.TextSize = 16
title.TextXAlignment = Enum.TextXAlignment.Left
title.Parent = header

local closeBtn = Instance.new("TextButton")
closeBtn.Size = UDim2.new(0, 34, 0, 26)
closeBtn.Position = UDim2.new(1, -40, 0, 8)
closeBtn.BackgroundColor3 = Color3.fromRGB(32, 38, 52)
closeBtn.BorderSizePixel = 0
closeBtn.AutoButtonColor = false
closeBtn.Text = "âŒ"
closeBtn.TextColor3 = Color3.fromRGB(230, 235, 245)
closeBtn.Font = Enum.Font.GothamBold
closeBtn.TextSize = 16
closeBtn.Parent = header
round(closeBtn, 10)

local closeStroke = Instance.new("UIStroke")
closeStroke.Thickness = 1
closeStroke.Transparency = 0.65
closeStroke.Color = Color3.fromRGB(120, 140, 170)
closeStroke.Parent = closeBtn

local subtitle = Instance.new("TextLabel")
subtitle.Size = UDim2.new(1, -18, 0, 16)
subtitle.Position = UDim2.new(0, 12, 0, 46)
subtitle.BackgroundTransparency = 1
subtitle.Text = "Click button to toggle luckyblock mode"
subtitle.TextColor3 = Color3.fromRGB(160, 170, 185)
subtitle.Font = Enum.Font.Gotham
subtitle.TextSize = 12
subtitle.TextXAlignment = Enum.TextXAlignment.Left
subtitle.Parent = container

local button = Instance.new("TextButton")
button.Size = UDim2.new(0.92, 0, 0, 50)
button.Position = UDim2.new(0.04, 0, 0, 86)
button.BackgroundColor3 = Color3.fromRGB(34, 92, 180)
button.BorderSizePixel = 0
button.AutoButtonColor = false
button.TextColor3 = Color3.fromRGB(255, 255, 255)
button.Font = Enum.Font.GothamBold
button.TextSize = 15
button.Parent = container
round(button, 12)

local btnGrad = Instance.new("UIGradient")
btnGrad.Rotation = 90
btnGrad.Color = ColorSequence.new({
	ColorSequenceKeypoint.new(0, Color3.fromRGB(70, 150, 240)),
	ColorSequenceKeypoint.new(1, Color3.fromRGB(34, 92, 180))
})
btnGrad.Parent = button

-- Mini toggle button (chá»‰ hiá»‡n khi panel bá»‹ áº©n)
local mini = Instance.new("TextButton")
mini.Size = UDim2.new(0, 54, 0, 54)
mini.Position = UDim2.new(1, -74, 1, -84)
mini.BackgroundColor3 = Color3.fromRGB(16, 18, 22)
mini.BorderSizePixel = 0
mini.AutoButtonColor = false
mini.Text = "ðŸŽ²"
mini.TextColor3 = Color3.fromRGB(255, 255, 255)
mini.Font = Enum.Font.GothamBold
mini.TextSize = 22
mini.Visible = false
mini.Parent = screenGui
round(mini, 18)

local miniStroke = Instance.new("UIStroke")
miniStroke.Thickness = 1
miniStroke.Transparency = 0.55
miniStroke.Color = Color3.fromRGB(120, 150, 210)
miniStroke.Parent = mini

-- ===== FULLSCREEN Loading (Ä‘en + title + process) =====
local overlay = Instance.new("Frame")
overlay.Size = UDim2.new(1, 0, 1, 0)
overlay.Position = UDim2.new(0, 0, 0, 0)
overlay.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
overlay.BackgroundTransparency = 1
overlay.Visible = false
overlay.ZIndex = 200
overlay.Parent = screenGui

local waitingTitle = Instance.new("TextLabel")
waitingTitle.Size = UDim2.new(1, -40, 0, 32)
waitingTitle.Position = UDim2.new(0, 20, 0.5, -70)
waitingTitle.BackgroundTransparency = 1
waitingTitle.Text = "Waiting to turn on the lucky block rain"
waitingTitle.TextColor3 = Color3.fromRGB(255, 255, 255)
waitingTitle.Font = Enum.Font.GothamSemibold
waitingTitle.TextSize = 18
waitingTitle.TextXAlignment = Enum.TextXAlignment.Center
waitingTitle.ZIndex = 201
waitingTitle.Parent = overlay

local barOuter = Instance.new("Frame")
barOuter.Size = UDim2.new(0.7, 0, 0, 10)
barOuter.Position = UDim2.new(0.5, 0, 0.5, -18)
barOuter.AnchorPoint = Vector2.new(0.5, 0.5)
barOuter.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
barOuter.BorderSizePixel = 0
barOuter.ZIndex = 201
barOuter.Parent = overlay
round(barOuter, 999)

local barFill = Instance.new("Frame")
barFill.Size = UDim2.new(0, 0, 1, 0)
barFill.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
barFill.BorderSizePixel = 0
barFill.ZIndex = 202
barFill.Parent = barOuter
round(barFill, 999)

-- ===== Drag header only =====
local dragging = false
local dragStart, startPos, activeInput

header.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
		dragging = true
		activeInput = input
		dragStart = input.Position
		startPos = container.Position
		input.Changed:Connect(function()
			if input.UserInputState == Enum.UserInputState.End then
				dragging = false
				activeInput = nil
			end
		end)
	end
end)

UserInputService.InputChanged:Connect(function(input)
	if dragging and input == activeInput then
		local delta = input.Position - dragStart
		container.Position = UDim2.new(
			startPos.X.Scale, startPos.X.Offset + delta.X,
			startPos.Y.Scale, startPos.Y.Offset + delta.Y
		)
	end
end)

-- ===== Logic =====
local enabled = false
local busy = false
local hidden = false

local function setState(isEnabled)
	enabled = isEnabled
	if enabled then
		button.Text = "Rainy Lucky BlockðŸŽ²: Enable"
	else
		button.Text = "Rainy Lucky BlockðŸŽ²: Disable"
	end
end

local function showPanel()
	if not hidden then return end
	hidden = false
	container.Visible = true
	mini.Visible = false
	setAllTransparency(container, 1)
	TweenService:Create(container, TweenInfo.new(0.18, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
		BackgroundTransparency = 0.06
	}):Play()
	-- fade in descendants manually
	for _, d in ipairs(container:GetDescendants()) do
		if d:IsA("Frame") then
			TweenService:Create(d, TweenInfo.new(0.18, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {BackgroundTransparency = (d == container and 0.06 or d.BackgroundTransparency)}):Play()
		elseif d:IsA("TextLabel") or d:IsA("TextButton") then
			TweenService:Create(d, TweenInfo.new(0.18, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {TextTransparency = 0, BackgroundTransparency = d.BackgroundTransparency}):Play()
		elseif d:IsA("UIStroke") then
			TweenService:Create(d, TweenInfo.new(0.18, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {Transparency = d.Transparency}):Play()
		end
	end
	-- Ä‘Æ¡n giáº£n hÃ³a: set tháº³ng sau 1 nhá»‹p
	task.delay(0.2, function()
		if container and container.Parent then
			setAllTransparency(container, 0) -- Ä‘Æ°a vá» rÃµ
			container.BackgroundTransparency = 0.06
		end
	end)
end

local function hidePanel()
	if hidden then return end
	hidden = true
	-- fade out nhanh
	for _, d in ipairs(container:GetDescendants()) do
		if d:IsA("TextLabel") or d:IsA("TextButton") then
			TweenService:Create(d, TweenInfo.new(0.15, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {TextTransparency = 1}):Play()
		end
		if d:IsA("Frame") then
			TweenService:Create(d, TweenInfo.new(0.15, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {BackgroundTransparency = 1}):Play()
		end
		if d:IsA("UIStroke") then
			TweenService:Create(d, TweenInfo.new(0.15, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {Transparency = 1}):Play()
		end
	end
	TweenService:Create(container, TweenInfo.new(0.15, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {BackgroundTransparency = 1}):Play()
	task.delay(0.16, function()
		if container and container.Parent then
			container.Visible = false
			mini.Visible = true
		end
	end)
end

local function runLoading3s()
	overlay.Visible = true
	overlay.BackgroundTransparency = 1
	barFill.Size = UDim2.new(0, 0, 1, 0)

	TweenService:Create(overlay, TweenInfo.new(0.12, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
		BackgroundTransparency = 0
	}):Play()

	local tw = TweenService:Create(barFill, TweenInfo.new(3, Enum.EasingStyle.Linear, Enum.EasingDirection.Out), {
		Size = UDim2.new(1, 0, 1, 0)
	})
	tw:Play()
	tw.Completed:Wait()

	TweenService:Create(overlay, TweenInfo.new(0.12, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
		BackgroundTransparency = 1
	}):Play()
	task.wait(0.12)
	overlay.Visible = false
end

-- Mini opens panel
mini.Activated:Connect(function()
	if busy then return end
	showPanel()
end)

-- âŒ: náº¿u Ä‘ang Enable thÃ¬ chat Ä‘á»ƒ táº¯t, rá»“i destroy
closeBtn.Activated:Connect(function()
	if busy then return end
	busy = true

	if enabled then
		pcall(function() sendChat("/luckyblockmode") end)
	end

	task.wait(0.05)
	if screenGui and screenGui.Parent then
		screenGui:Destroy()
	end
end)

-- Main button: loading -> chat -> toggle state -> hide panel
button.Activated:Connect(function()
	if busy then return end
	busy = true
	button.Active = false

	runLoading3s()

	local ok = sendChat("/luckyblockmode")
	if ok then
		setState(not enabled) -- âœ… Disable váº«n cÃ³ thá»ƒ báº¥m báº­t láº¡i
		hidePanel()           -- âœ… chat xong áº©n UI
	else
		local oldText = button.Text
		button.Text = "Chat failed"
		task.wait(0.9)
		button.Text = oldText
	end

	button.Active = true
	busy = false
end)

setState(false)
